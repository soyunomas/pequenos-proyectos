<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Ritmo GPS</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Estilos personalizados */
        body {
            padding-top: 1rem;
            padding-bottom: 5rem; /* Espacio extra abajo para log de errores */
            background-color: #f8f9fa;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s;
        }

        .screen.active {
            display: block;
        }

        #timeDifferenceDisplay {
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #e9ecef;
            min-height: 80px; /* Altura mínima para evitar saltos */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #timeDifferenceDisplay.positive { color: #dc3545; }
        #timeDifferenceDisplay.negative { color: #198754; }
        #timeDifferenceDisplay.zero { color: #6c757d; }

        .list-group-item-action { cursor: pointer; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .status-indicator {
            font-style: italic;
            color: #6c757d;
        }
         .status-indicator.active {
             color: #0d6efd;
             font-weight: bold;
         }
         .gps-status {
             font-size: 0.9rem;
             margin-top: 1rem;
         }

         /* Estilos para el Log de Errores */
         #errorLogContainer {
             position: fixed; /* Fijo en la parte inferior */
             bottom: 0;
             left: 0;
             right: 0;
             max-height: 150px; /* Altura máxima */
             overflow-y: auto; /* Scroll si hay muchos errores */
             background-color: #f8d7da; /* Fondo rojo claro */
             border-top: 1px solid #f5c6cb; /* Borde rojo */
             padding: 0.5rem 1rem;
             font-size: 0.8rem;
             color: #721c24; /* Texto rojo oscuro */
             z-index: 1050; /* Por encima de otros elementos */
         }
         #errorLogContainer .error-entry {
             border-bottom: 1px dashed #f5c6cb;
             padding-bottom: 0.3rem;
             margin-bottom: 0.3rem;
             white-space: pre-wrap; /* Para respetar saltos de línea en stack */
             word-wrap: break-word; /* Para romper palabras largas */
         }
          #errorLogContainer .error-entry:last-child {
              border-bottom: none;
              margin-bottom: 0;
          }
         #errorLogContainer p {
             margin-bottom: 0.2rem;
             font-weight: bold;
         }

    </style>
</head>
<body>
    <div class="container mt-3">
        <h1 class="text-center mb-4">Mi Ritmo GPS <i class="fas fa-route text-primary"></i></h1>

        <div id="statusMessage" class="alert alert-warning d-none" role="alert"></div>
        <div id="gpsStatusMessage" class="gps-status text-center mb-3"></div>

        <!-- Pantalla Principal (Home) -->
        <div id="homeScreen" class="screen active text-center">
            <h2>Menú Principal</h2>
            <div class="d-grid gap-2 col-8 mx-auto mt-4">
                <button id="btnGoToRecord" class="btn btn-primary btn-lg"><i class="fas fa-play-circle"></i> Grabar Nueva Ruta</button>
                <button id="btnGoToList" class="btn btn-success btn-lg"><i class="fas fa-list"></i> Comparar con Ruta Guardada</button>
            </div>
        </div>

        <!-- Pantalla de Grabación -->
        <div id="recordScreen" class="screen">
            <h2><i class="fas fa-record-vinyl text-danger"></i> Grabar Nueva Ruta</h2>
             <div class="mb-3">
                 <label class="form-label">Modo:</label>
                 <div>
                     <input type="radio" class="btn-check" name="recordMode" id="modeConducir" value="Conducir" autocomplete="off" checked>
                     <label class="btn btn-outline-primary" for="modeConducir"><i class="fas fa-car"></i> Conducir</label>

                     <input type="radio" class="btn-check" name="recordMode" id="modeCaminar" value="Caminar" autocomplete="off">
                     <label class="btn btn-outline-success" for="modeCaminar"><i class="fas fa-walking"></i> Caminar/Correr</label>
                 </div>
             </div>
            <div class="text-center mb-3">
                <span id="recordStatus" class="status-indicator">Esperando para iniciar...</span> <br>
                <span id="pointsCaptured" class="badge bg-secondary mt-1">Puntos capturados: 0</span>
            </div>
            <div class="d-grid gap-2 col-8 mx-auto">
                <button id="btnStartRecording" class="btn btn-danger"><i class="fas fa-play"></i> Iniciar Grabación</button>
                <button id="btnStopRecording" class="btn btn-warning d-none"><i class="fas fa-stop"></i> Detener Grabación</button>
            </div>
             <div id="saveRouteSection" class="mt-4 d-none">
                 <div class="mb-3">
                     <label for="routeNameInput" class="form-label">Nombre de la Ruta:</label>
                     <input type="text" class="form-control" id="routeNameInput" placeholder="Ej: Camino al trabajo - Coche">
                 </div>
                 <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                     <button id="btnSaveRoute" class="btn btn-success"><i class="fas fa-save"></i> Guardar Ruta</button>
                     <button id="btnDiscardRoute" class="btn btn-secondary"><i class="fas fa-times"></i> Descartar</button>
                 </div>
             </div>
            <button id="btnRecordBack" class="btn btn-outline-secondary mt-4 w-100"><i class="fas fa-arrow-left"></i> Volver al Menú</button>
        </div>

        <!-- Pantalla de Lista de Rutas -->
        <div id="listScreen" class="screen">
            <h2><i class="fas fa-list-ul text-info"></i> Seleccionar Ruta de Referencia</h2>
            <div id="routeList" class="list-group mt-3">
                <p id="noRoutesMessage" class="text-center text-muted">Aún no has guardado ninguna ruta.</p>
            </div>
            <button id="btnListBack" class="btn btn-outline-secondary mt-4 w-100"><i class="fas fa-arrow-left"></i> Volver al Menú</button>
        </div>

        <!-- Pantalla de Comparación -->
        <div id="compareScreen" class="screen">
            <h2><i class="fas fa-tachometer-alt text-warning"></i> Comparación en Vivo</h2>
            <div class="card text-center mb-3">
                <div class="card-header">
                    Ruta de Referencia
                </div>
                <div class="card-body">
                    <h5 id="compareRouteName" class="card-title">--</h5>
                    <p id="compareRouteMode" class="card-text text-muted">Modo: --</p>
                </div>
            </div>

            <div id="timeDifferenceDisplay" class="zero">--:--</div>

            <div class="row text-center mb-3">
                <div class="col">
                    <strong>Tu Tiempo:</strong> <span id="currentTimeDisplay">00:00</span>
                </div>
                <div class="col">
                    <strong>Tiempo Ref.:</strong> <span id="referenceTimeDisplay">00:00</span>
                </div>
            </div>
             <div class="text-center mb-3">
                <span id="compareStatus" class="status-indicator">Listo para comparar.</span>
            </div>

            <div class="d-grid gap-2 col-8 mx-auto">
                <button id="btnStartComparison" class="btn btn-success"><i class="fas fa-play-circle"></i> Iniciar Comparación</button>
                <button id="btnStopComparison" class="btn btn-danger d-none"><i class="fas fa-stop-circle"></i> Detener Comparación</button>
            </div>

            <button id="btnCompareBack" class="btn btn-outline-secondary mt-4 w-100"><i class="fas fa-arrow-left"></i> Volver a la Lista</button>
        </div>

    </div>

    <!-- Contenedor para mostrar errores de JS -->
    <div id="errorLogContainer">
        <p>Registro de Errores de JavaScript:</p>
        </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <!-- JavaScript -->
    <script>
        // --- Manejo Global de Errores para mostrar en HTML ---
        const errorLogContainer = document.getElementById('errorLogContainer');

        function logErrorToHTML(message, source, lineno, colno, error) {
            const errorElement = document.createElement('div');
            errorElement.className = 'error-entry';
            let errorMessage = `Error: ${message}`;
            if (source) errorMessage += `\nEn: ${source}`;
            if (lineno) errorMessage += ` (Línea: ${lineno}, Col: ${colno})`;
            if (error && error.stack) errorMessage += `\nStack: ${error.stack}`;
            errorElement.textContent = errorMessage;
            // Insertar al principio para ver los más recientes primero
            if(errorLogContainer.children.length > 1) { // Si ya hay <p> y otros errores
                 errorLogContainer.insertBefore(errorElement, errorLogContainer.children[1]);
            } else {
                 errorLogContainer.appendChild(errorElement); // Si es el primer error
            }

            console.error("Error capturado:", message, source, lineno, colno, error); // También mostrar en consola si es posible
        }

        window.onerror = function (message, source, lineno, colno, error) {
            logErrorToHTML(message, source, lineno, colno, error);
            return true; // Evita que el navegador muestre su propio diálogo de error
        };

        window.addEventListener('unhandledrejection', function (event) {
             let reason = event.reason;
             let errorMessage = "Error no manejado en Promesa: ";
             if (reason instanceof Error) {
                 errorMessage += `${reason.message}\nStack: ${reason.stack}`;
             } else {
                 errorMessage += String(reason);
             }
            logErrorToHTML(errorMessage, event.type, null, null, reason instanceof Error ? reason : null);
        });

        // --- Constantes y Variables Globales ---
        const STORAGE_KEY = 'miRitmoGPS_routes';
        const GEOLOCATION_OPTIONS = {
            enableHighAccuracy: true,
            maximumAge: 0
        };

        let currentScreen = 'homeScreen';
        let isRecording = false;
        let isComparing = false;
        let watchId = null;
        let startTime = null;
        let currentRouteData = { mode: null, track: [] };
        let currentComparisonData = { track: [] };
        let referenceRouteData = null;
        let savedRoutes = [];

        // --- Referencias a Elementos del DOM ---
        const screens = {
            home: document.getElementById('homeScreen'),
            record: document.getElementById('recordScreen'),
            list: document.getElementById('listScreen'),
            compare: document.getElementById('compareScreen')
        };
        const statusMessage = document.getElementById('statusMessage');
        const gpsStatusMessage = document.getElementById('gpsStatusMessage');
        const btnGoToRecord = document.getElementById('btnGoToRecord');
        const btnGoToList = document.getElementById('btnGoToList');
        const recordStatus = document.getElementById('recordStatus');
        const pointsCaptured = document.getElementById('pointsCaptured');
        const btnStartRecording = document.getElementById('btnStartRecording');
        const btnStopRecording = document.getElementById('btnStopRecording');
        const saveRouteSection = document.getElementById('saveRouteSection');
        const routeNameInput = document.getElementById('routeNameInput');
        const btnSaveRoute = document.getElementById('btnSaveRoute');
        const btnDiscardRoute = document.getElementById('btnDiscardRoute');
        const btnRecordBack = document.getElementById('btnRecordBack');
        const recordModeRadios = document.querySelectorAll('input[name="recordMode"]');
        const routeListContainer = document.getElementById('routeList');
        const noRoutesMessage = document.getElementById('noRoutesMessage');
        const btnListBack = document.getElementById('btnListBack');
        const compareRouteName = document.getElementById('compareRouteName');
        const compareRouteMode = document.getElementById('compareRouteMode');
        const timeDifferenceDisplay = document.getElementById('timeDifferenceDisplay');
        const currentTimeDisplay = document.getElementById('currentTimeDisplay');
        const referenceTimeDisplay = document.getElementById('referenceTimeDisplay');
        const compareStatus = document.getElementById('compareStatus');
        const btnStartComparison = document.getElementById('btnStartComparison');
        const btnStopComparison = document.getElementById('btnStopComparison');
        const btnCompareBack = document.getElementById('btnCompareBack');


        // --- Funciones de Utilidad ---

        function showStatus(message, type = 'warning') {
            statusMessage.textContent = message;
            statusMessage.className = `alert alert-${type}`;
            statusMessage.classList.remove('d-none');
            setTimeout(() => { statusMessage.classList.add('d-none'); }, 5000);
        }

        function hideStatus() { statusMessage.classList.add('d-none'); }

        function updateGpsStatus(message, isActive = false) {
            gpsStatusMessage.textContent = message;
            gpsStatusMessage.className = `gps-status text-center mb-3 ${isActive ? 'text-primary fw-bold' : 'text-muted'}`;
        }

        function showScreen(screenId) {
            currentScreen = screenId;
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenId.replace('Screen', '')].classList.add('active');
            hideStatus();
            if (screenId !== 'recordScreen' && screenId !== 'compareScreen') {
                 stopTracking(); // Detener GPS si no estamos grabando o comparando
                 updateGpsStatus('');
            }
            if (screenId === 'homeScreen') {
                 resetRecordScreen();
                 resetCompareScreen();
            }
            if (screenId === 'listScreen') { displayRoutes(); }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Metros
            const φ1 = lat1 * Math.PI / 180, φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ / 2)**2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function formatTime(ms) {
            if (ms === null || isNaN(ms)) return '--:--';
            const totalSeconds = Math.max(0, Math.round(ms / 1000)); // Asegurar que no sea negativo
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function formatTimeDifference(ms) {
             if (ms === null || isNaN(ms)) return '--:--';
             const totalSeconds = Math.round(ms / 1000);
             const sign = totalSeconds >= 0 ? '+' : '-';
             const absSeconds = Math.abs(totalSeconds);
             const minutes = Math.floor(absSeconds / 60);
             const seconds = absSeconds % 60;
             let className = 'zero';
             if (totalSeconds > 5) className = 'positive';      // Umbral para rojo
             else if (totalSeconds < -5) className = 'negative'; // Umbral para verde
             timeDifferenceDisplay.className = className;
             return `${sign}${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
         }

        // --- Lógica de Geolocalización ---

        function handlePositionUpdate(position) {
            const { latitude, longitude } = position.coords;
            const timestamp = Date.now();
            const elapsedTime = timestamp - startTime;

            updateGpsStatus(`GPS Activo: Lat ${latitude.toFixed(4)}, Lon ${longitude.toFixed(4)}`, true);

            const newPoint = { lat: latitude, lon: longitude, timestamp: elapsedTime };

            if (isRecording) {
                currentRouteData.track.push(newPoint);
                pointsCaptured.textContent = `Puntos capturados: ${currentRouteData.track.length}`;
                recordStatus.textContent = `Grabando... (${formatTime(elapsedTime)})`;
            } else if (isComparing && referenceRouteData) {
                currentComparisonData.track.push(newPoint);

                let minDistance = Infinity;
                let nearestRefPoint = null;
                // Optimización simple: solo buscar cerca del último punto encontrado si existe
                // Para un MVP, la búsqueda completa está bien, pero esto es una idea:
                 let searchStartIndex = 0;
                 /* // Lógica más compleja para buscar cerca:
                 if (currentComparisonData.lastNearestIndex) {
                     searchStartIndex = Math.max(0, currentComparisonData.lastNearestIndex - 10); // Buscar un poco atrás
                 }
                 const searchEndIndex = Math.min(referenceRouteData.track.length, searchStartIndex + 100); // Buscar adelante
                 */
                for (let i = 0; i < referenceRouteData.track.length; i++) { // Búsqueda completa por ahora
                    const point = referenceRouteData.track[i];
                    const distance = calculateDistance(latitude, longitude, point.lat, point.lon);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestRefPoint = point;
                         // currentComparisonData.lastNearestIndex = i; // Guardar índice para optimización futura
                    }
                }

                let referenceTime = null;
                let timeDifference = null;
                if (nearestRefPoint) {
                    referenceTime = nearestRefPoint.timestamp;
                    timeDifference = elapsedTime - referenceTime;
                }

                currentTimeDisplay.textContent = formatTime(elapsedTime);
                referenceTimeDisplay.textContent = formatTime(referenceTime);
                timeDifferenceDisplay.textContent = formatTimeDifference(timeDifference);
                compareStatus.textContent = `Comparando... (Dist. Ref: ${minDistance.toFixed(0)}m)`;
            }
        }

        function handlePositionError(error) {
            let message = `Error GPS (${error.code}): `;
            switch (error.code) {
                case error.PERMISSION_DENIED: message += "Permiso denegado."; break;
                case error.POSITION_UNAVAILABLE: message += "Ubicación no disponible."; break;
                case error.TIMEOUT: message += "Timeout."; break;
                default: message += "Desconocido."; break;
            }
             // Mostrar error en el log HTML Y en el status normal
            logErrorToHTML(message, "handlePositionError", null, null, error);
            showStatus(message, 'danger');
            updateGpsStatus('Error de GPS', false);
            stopTracking(); // Detener si hay error
        }

        function startTracking(onSuccess) {
            if (!navigator.geolocation) {
                showStatus('Geolocalización no soportada.', 'danger');
                return false;
            }
            if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }

            updateGpsStatus('Iniciando GPS...', false);
            let firstSuccess = true; // Flag para llamar onSuccess solo una vez

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    if (firstSuccess && onSuccess) {
                        onSuccess();
                        firstSuccess = false;
                    }
                    handlePositionUpdate(position);
                },
                handlePositionError,
                GEOLOCATION_OPTIONS
            );
            console.log("GPS Watcher iniciado:", watchId);
            return true;
        }

        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                console.log("GPS Watcher detenido:", watchId);
                watchId = null;
            }
             // Solo poner GPS Inactivo si realmente se detuvo
             if (!isRecording && !isComparing) {
                  updateGpsStatus('GPS Inactivo', false);
             }
             // No resetear flags isRecording/isComparing aquí, se hace en sus funciones stop
        }

        // --- Lógica de Grabación ---

        function resetRecordScreen() {
            currentRouteData = { mode: null, track: [] };
            isRecording = false; // Asegurar que se reinicia el estado
            startTime = null;
            recordStatus.textContent = 'Esperando para iniciar...';
            recordStatus.classList.remove('active');
            pointsCaptured.textContent = 'Puntos capturados: 0';
            btnStartRecording.disabled = false; // Habilitar botón de inicio
            btnStartRecording.classList.remove('d-none');
            btnStopRecording.classList.add('d-none');
            saveRouteSection.classList.add('d-none');
            routeNameInput.value = '';
            recordModeRadios[0].checked = true;
        }

        function startRecording() {
            if (isRecording) return;
             // No resetear aquí, se resetea al entrar a la pantalla o al descartar/guardar
            // resetRecordScreen();

            const selectedMode = document.querySelector('input[name="recordMode"]:checked').value;
            currentRouteData = { mode: selectedMode, track: [] }; // Reiniciar datos para nueva grabación

             recordStatus.textContent = 'Iniciando GPS para grabar...';
             recordStatus.classList.add('active');
             btnStartRecording.disabled = true; // Deshabilitar mientras inicia

            const trackingStarted = startTracking(() => {
                isRecording = true;
                startTime = Date.now();
                recordStatus.textContent = 'Grabando... (00:00)';
                recordStatus.classList.add('active'); // Asegurar que sigue activo
                btnStartRecording.classList.add('d-none');
                btnStopRecording.classList.remove('d-none');
                 btnStartRecording.disabled = false; // Rehabilitar por si acaso
                saveRouteSection.classList.add('d-none');
                console.log(`Grabación iniciada: ${selectedMode}`);
            });

             if (!trackingStarted) {
                  showStatus("No se pudo iniciar el GPS.", "danger");
                  recordStatus.textContent = 'Error al iniciar GPS';
                  recordStatus.classList.remove('active');
                  btnStartRecording.disabled = false; // Rehabilitar si falló
             }
        }

        function stopRecording() {
            if (!isRecording) return;
            const endTime = Date.now();
            const duration = startTime ? endTime - startTime : 0;
            isRecording = false; // Marcar como no grabando ANTES de detener tracking
            stopTracking();
            recordStatus.textContent = `Grabación detenida. Puntos: ${currentRouteData.track.length}. Duración: ${formatTime(duration)}`;
            recordStatus.classList.remove('active');
            btnStartRecording.classList.remove('d-none');
            btnStartRecording.disabled = false; // Habilitar botón de inicio
            btnStopRecording.classList.add('d-none');

            if (currentRouteData.track.length > 1) {
                 currentRouteData.duration = duration; // Guardar duración final
                saveRouteSection.classList.remove('d-none');
            } else {
                showStatus("Ruta demasiado corta para guardar.", "warning");
                resetRecordScreen(); // Resetear si es muy corta
            }
        }

        function saveRoute() {
            const name = routeNameInput.value.trim();
            if (!name) { showStatus("Introduce un nombre.", "warning"); return; }
            if (currentRouteData.track.length < 2) { showStatus("Ruta sin puntos suficientes.", "warning"); return; }

            const newRoute = {
                id: Date.now().toString(),
                name: name,
                mode: currentRouteData.mode,
                track: currentRouteData.track,
                duration: currentRouteData.duration || (currentRouteData.track.length > 0 ? currentRouteData.track[currentRouteData.track.length - 1].timestamp : 0) // Usar duración calculada o la del último punto
            };

            loadRoutes(); // Cargar por si acaso hubo cambios
            savedRoutes.push(newRoute);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedRoutes));
            showStatus(`Ruta "${name}" guardada.`, 'success');
            resetRecordScreen();
            showScreen('listScreen');
        }

        function discardRoute() { resetRecordScreen(); showStatus("Grabación descartada.", "info"); }


        // --- Lógica de Lista/Selección de Rutas ---

        function loadRoutes() {
            try {
                const routesJSON = localStorage.getItem(STORAGE_KEY);
                savedRoutes = routesJSON ? JSON.parse(routesJSON) : [];
            } catch (e) {
                 savedRoutes = [];
                 logErrorToHTML("Error al cargar/parsear rutas de LocalStorage.", "loadRoutes", null, null, e);
                 showStatus("Error al cargar rutas guardadas.", "danger");
                 localStorage.removeItem(STORAGE_KEY); // Limpiar si está corrupto
            }

        }

        function displayRoutes() {
            loadRoutes();
            routeListContainer.innerHTML = ''; // Limpiar antes de añadir
            if (savedRoutes.length === 0) {
                noRoutesMessage.classList.remove('d-none');
            } else {
                noRoutesMessage.classList.add('d-none');
                savedRoutes.forEach((route, index) => {
                    if (!route || typeof route !== 'object') { // Chequeo de seguridad
                         logErrorToHTML(`Elemento inválido encontrado en savedRoutes en índice ${index}`, "displayRoutes");
                         return; // Saltar este elemento inválido
                    }
                    const listItem = document.createElement('button');
                    listItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    listItem.setAttribute('data-route-index', index);

                    // *** CORRECCIÓN DE ICONO (case-insensitive) ***
                    const modeLower = typeof route.mode === 'string' ? route.mode.toLowerCase() : '';
                    const iconClass = modeLower === 'conducir' ? 'fa-car' : 'fa-walking';

                    const durationFormatted = formatTime(route.duration || 0); // Usar 0 si duration falta

                    listItem.innerHTML = `
                        <span><i class="fas ${iconClass} me-2"></i> ${route.name || 'Ruta sin nombre'}</span>
                        <span class="badge bg-primary rounded-pill">${durationFormatted}</span>
                    `;
                    listItem.addEventListener('click', () => selectRouteForComparison(index));
                    routeListContainer.appendChild(listItem);
                });
            }
        }

        function selectRouteForComparison(index) {
            console.log(`Intentando seleccionar índice: ${index}`);
            // Asegurarse que savedRoutes está cargado
            if (!Array.isArray(savedRoutes)) loadRoutes();

            if (index >= 0 && index < savedRoutes.length) {
                 referenceRouteData = savedRoutes[index];
                console.log('Datos de ruta seleccionada:', JSON.stringify(referenceRouteData));
                if (!referenceRouteData || !referenceRouteData.name || !referenceRouteData.mode || !Array.isArray(referenceRouteData.track)) {
                     logErrorToHTML("Datos de ruta seleccionada inválidos o incompletos.", "selectRouteForComparison", null, null, new Error(JSON.stringify(referenceRouteData)));
                     showStatus("Error: Datos de la ruta seleccionada son inválidos.", "danger");
                     referenceRouteData = null;
                     return;
                }
                prepareCompareScreen();
                showScreen('compareScreen');
            } else {
                logErrorToHTML(`Índice de ruta fuera de rango: ${index}`, "selectRouteForComparison");
                showStatus(`Error al seleccionar ruta (índice inválido: ${index}).`, "danger");
            }
        }


        // --- Lógica de Comparación ---

         function resetCompareScreen() {
            // No resetear referenceRouteData aquí, se necesita para prepareCompareScreen
            currentComparisonData = { track: [] /*, lastNearestIndex: undefined */ };
            isComparing = false; // Asegurar reseteo
            startTime = null;
            compareRouteName.textContent = '--';
            compareRouteMode.textContent = 'Modo: --';
            timeDifferenceDisplay.textContent = '--:--';
            timeDifferenceDisplay.className = 'zero';
            currentTimeDisplay.textContent = '00:00';
            referenceTimeDisplay.textContent = '00:00';
            compareStatus.textContent = 'Listo para comparar.';
            compareStatus.classList.remove('active');
            btnStartComparison.disabled = false; // Habilitar botón
            btnStartComparison.classList.remove('d-none');
            btnStopComparison.classList.add('d-none');
         }

        function prepareCompareScreen() {
             resetCompareScreen(); // Limpia estado de comparación, pero no referenceRouteData
            if (!referenceRouteData) {
                 logErrorToHTML("prepareCompareScreen llamada sin referenceRouteData.", "prepareCompareScreen");
                 showStatus("Error: No hay ruta de referencia.", "danger");
                 showScreen('listScreen');
                 return;
            }
            compareRouteName.textContent = referenceRouteData.name;
            compareRouteMode.textContent = `Modo: ${referenceRouteData.mode}`;
            // Inicializar tiempos a 0
            currentTimeDisplay.textContent = formatTime(0);
            referenceTimeDisplay.textContent = formatTime(0);
            timeDifferenceDisplay.textContent = formatTimeDifference(0);
            timeDifferenceDisplay.className = 'zero';
            compareStatus.textContent = 'Pulsa "Iniciar Comparación"';
            btnStartComparison.disabled = false; // Asegurar que está habilitado
         }

        function startComparison() {
            if (isComparing || !referenceRouteData) return;
            currentComparisonData = { track: [] }; // Limpiar datos previos

             compareStatus.textContent = 'Iniciando GPS para comparar...';
             compareStatus.classList.add('active');
             btnStartComparison.disabled = true; // Deshabilitar mientras inicia

            const trackingStarted = startTracking(() => {
                 isComparing = true;
                 startTime = Date.now();
                 compareStatus.textContent = 'Comparando...';
                  compareStatus.classList.add('active'); // Asegurar que sigue activo
                 btnStartComparison.classList.add('d-none');
                 btnStopComparison.classList.remove('d-none');
                 btnStartComparison.disabled = false; // Rehabilitar por si acaso
                 console.log("Comparación iniciada contra:", referenceRouteData.name);
             });

             if (!trackingStarted) {
                  showStatus("No se pudo iniciar el GPS.", "danger");
                   compareStatus.textContent = 'Error al iniciar GPS';
                   compareStatus.classList.remove('active');
                   btnStartComparison.disabled = false; // Rehabilitar si falló
             }
        }

        function stopComparison() {
            if (!isComparing) return;
            const finalElapsedTime = startTime ? Date.now() - startTime : 0;
            isComparing = false; // Marcar como no comparando ANTES de stopTracking
            stopTracking();
            compareStatus.textContent = `Comparación detenida. Duración: ${formatTime(finalElapsedTime)}`;
            compareStatus.classList.remove('active');
            btnStartComparison.classList.remove('d-none');
            btnStartComparison.disabled = false; // Habilitar botón
            btnStopComparison.classList.add('d-none');
        }


        // --- Inicialización y Event Listeners ---

        function initApp() {
            console.log("Iniciando Mi Ritmo GPS...");

            // Navegación
            btnGoToRecord.addEventListener('click', () => showScreen('recordScreen'));
            btnGoToList.addEventListener('click', () => showScreen('listScreen'));
            btnRecordBack.addEventListener('click', () => {
                 if (isRecording) stopRecording(); // Detener si necesario
                 resetRecordScreen(); // Limpiar pantalla de grabación
                 showScreen('homeScreen');
             });
            btnListBack.addEventListener('click', () => showScreen('homeScreen'));
             btnCompareBack.addEventListener('click', () => {
                 if (isComparing) stopComparison(); // Detener si necesario
                 resetCompareScreen(); // Limpiar pantalla de comparación
                 showScreen('listScreen');
             });


            // Acciones de Grabación
            btnStartRecording.addEventListener('click', startRecording);
            btnStopRecording.addEventListener('click', stopRecording);
            btnSaveRoute.addEventListener('click', saveRoute);
            btnDiscardRoute.addEventListener('click', discardRoute);


            // Acciones de Comparación
            btnStartComparison.addEventListener('click', startComparison);
            btnStopComparison.addEventListener('click', stopComparison);

             // Verificar GPS al inicio
             if (!navigator.geolocation) {
                 showStatus('Geolocalización no soportada.', 'danger');
                 updateGpsStatus('GPS No Soportado', false);
                 btnGoToRecord.disabled = true;
                 // Permitir ver la lista, pero los botones de inicio fallarán
                 // btnGoToList.disabled = true;
             } else {
                  updateGpsStatus('GPS Soportado. Solicitará permiso al usar.');
             }

             // Mostrar pantalla inicial
            showScreen('homeScreen');
        }

        // Iniciar la aplicación
        try {
             document.addEventListener('DOMContentLoaded', initApp);
        } catch (e) {
             // Capturar errores durante la carga inicial del script/DOM
             logErrorToHTML("Error fatal durante inicialización.", "Script Principal", null, null, e);
        }

    </script>
</body>
</html>