# ==============================================================================
# GOKVM MAKEFILE
# ==============================================================================

# Variables del proyecto
BINARY_DIR=bin
SERVER_SRC=./cmd/server
CLIENT_SRC=./cmd/client
APP_NAME=gokvm

# Banderas de compilaci√≥n
# -s: Omitir la tabla de s√≠mbolos (menor tama√±o)
# -w: Omitir informaci√≥n de depuraci√≥n DWARF (menor tama√±o)
LDFLAGS=-ldflags "-s -w"

# Detectar el Sistema Operativo para los comandos de limpieza
ifeq ($(OS),Windows_NT)
    RM = del /Q /F
    MKDIR = mkdir
else
    RM = rm -rf
    MKDIR = mkdir -p
endif

.PHONY: all build build-linux build-windows run-server run-client clean dep fmt vet help

# ==============================================================================
# COMANDOS PRINCIPALES
# ==============================================================================

# Target por defecto: Ayuda
all: help

## build: Compila el proyecto para el SO actual (Linux)
build: dep fmt vet
	@echo "üî® Compilando para Linux..."
	@$(MKDIR) $(BINARY_DIR)
	go build $(LDFLAGS) -o $(BINARY_DIR)/server $(SERVER_SRC)
	go build $(LDFLAGS) -o $(BINARY_DIR)/client $(CLIENT_SRC)
	@echo "‚úÖ ¬°Compilaci√≥n completada! Binarios en /$(BINARY_DIR)"

## build-windows: Compilaci√≥n cruzada para Windows desde Linux
build-windows: dep
	@echo "ü™ü Compilando para Windows (amd64)..."
	@$(MKDIR) $(BINARY_DIR)
	GOOS=windows GOARCH=amd64 go build $(LDFLAGS) -o $(BINARY_DIR)/server.exe $(SERVER_SRC)
	GOOS=windows GOARCH=amd64 go build $(LDFLAGS) -o $(BINARY_DIR)/client.exe $(CLIENT_SRC)
	@echo "‚úÖ ¬°Ejecutables .exe generados en /$(BINARY_DIR)!"

## run-server: Ejecuta el servidor (Server)
run-server:
	@echo "üöÄ Ejecutando Servidor..."
	@go run $(SERVER_SRC)/main.go

## run-client: Ejecuta el cliente (Client) por defecto
run-client:
	@echo "üíª Ejecutando Cliente..."
	@go run $(CLIENT_SRC)/main.go

# ==============================================================================
# DESARROLLO Y MANTENIMIENTO
# ==============================================================================

## dep: Descarga y limpia dependencias (go mod tidy)
dep:
	@echo "üì¶ Gestionando dependencias..."
	@go mod tidy

## fmt: Formatea todo el c√≥digo .go del proyecto
fmt:
	@echo "üßπ Formateando c√≥digo..."
	@go fmt ./...

## vet: Analiza el c√≥digo en busca de errores sospechosos
vet:
	@echo "üîç Analizando c√≥digo (go vet)..."
	@go vet ./...

## clean: Elimina la carpeta de binarios y archivos temporales
clean:
	@echo "üóëÔ∏è  Limpiando..."
	@$(RM) $(BINARY_DIR)
	@echo "‚ú® Limpio."

# ==============================================================================
# AYUDA
# ==============================================================================

## help: Muestra esta ayuda
help:
	@echo ""
	@echo "Uso: make [comando]"
	@echo ""
	@echo "Comandos disponibles:"
	@sed -n 's/^##//p' $(MAKEFILE_LIST) | column -t -s ':' |  sed -e 's/^/ /'
	@echo ""
